{{ define "title" }}{{ .Title }}{{ end }}

{{define "flashes"}}{{ .Flashes }}{{end}}

{{ define "content" }}
    <div class="padding">
        <h2>{{ .Town.Name }}</h2>
        <p>
            <strong>Current User:</strong> {{ .User.ID }}<br>
            <strong>Town Owner:</strong> {{ .Town.Owner }}<br>
            <strong>Town ID:</strong> {{ .Town.ID }}<br>
            <strong>Town created:</strong> {{ .Town.FormattedCreatedAt }}<br>
            <strong>Town updated:</strong> {{ .Town.FormattedUpdatedAt }}<br>
        </p>

        <ul class="topnav">
            <li><a href="#town" class="button small">Town</a></li>
            <li><a href="#warehouse" class="button small">Warehouse</a></li>
            <li><a href="#buildqueue" class="button small">Build queue</a></li>
        </ul>

        <div class="row" id="town">
            {{ range $townBuilding := .Town.Buildings }}
                {{ $building := index $.Buildings $townBuilding.Type }}
                <div class="col-6 col-4-md">
                    <div class="card is-full-height">
                        <header>
                            <h3>{{ $building.Name }}</h3>
                        </header>
                        <img src="{{ $building.Image }}" alt="{{ $building.Name }}" class="pull-right">
                        <p>{{ $building.Description }}</p>
                        <span class="clearfix">&nbsp;</span>
                        <nav class="tabs is-full" role="tablist">
                            <a aria-controls="tb_{{ $townBuilding.ID }}_overview" class="tb_tab active">
                                <img src="https://icongr.am/feather/home.svg" alt="Overview">
                            </a>
                            <a aria-controls="tb_{{ $townBuilding.ID }}_production" class="tb_tab">
                                <img src="https://icongr.am/feather/package.svg" alt="Production">
                            </a>
                            <a aria-controls="tb_{{ $townBuilding.ID }}_construction" class="tb_tab">
                                <img src="https://icongr.am/feather/settings.svg" alt="Construction">
                            </a>
                        </nav>
                        <div id="tb_{{ $townBuilding.ID }}_overview" class="tb_pane_{{ $townBuilding.ID }}"
                             role="tabpanel" tabindex="0">
                            <table class="striped">
                                <tr>
                                    <th style="width: 50%;">Level</th>
                                    <td>{{ $townBuilding.CurrentLevel }}</td>
                                </tr>
                                <tr>
                                    <th>Consumes</th>
                                    <td>
                                        {{ range $consume := $building.ConsumesList }}
                                            {{ $item := index $.Items $consume }}
                                            <p>
                                                <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                {{ $item.Name }}
                                            </p>
                                        {{ else }}
                                            <em>Nothing</em>
                                        {{ end }}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Produces</th>
                                    <td>
                                        {{ range $produce := $building.ProducesList }}
                                            {{ $item := index $.Items $produce }}
                                            <p>
                                                <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                {{ $item.Name }}
                                            </p>
                                        {{ else }}
                                            <em>Nothing</em>
                                        {{ end }}
                                    </td>
                                </tr>
                                {{ range $mechanic := $building.Mechanics }}
                                    <tr>
                                        <th>{{ $mechanic.Name }}</th>
                                        <td>{{ index $mechanic.Levels $townBuilding.CurrentLevel }}</td>
                                    </tr>
                                {{ end }}
                            </table>
                        </div>
                        <div id="tb_{{ $townBuilding.ID }}_production" class="tb_pane_{{ $townBuilding.ID }}"
                             role="tabpanel" tabindex="0" hidden>
                            <table class="striped">
                                <caption>Modifiers</caption>
                                {{ range $mechanic := $building.Mechanics }}
                                    <tr>
                                        <td>
                                            <strong>{{ $mechanic.Name }}</strong><br>
                                            <em>{{ $mechanic.Type }}</em>
                                        </td>
                                        <td>{{ index $mechanic.Levels $townBuilding.CurrentLevel }}</td>
                                    </tr>
                                {{ end }}
                            </table>

                            <table class="striped">
                                <caption>Production</caption>
                                <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>&nbsp;</th>
                                </tr>
                                </thead>
                                <tbody>
                                {{ range $produce, $set := $building.Production }}
                                {{ $item := index $.Items $produce.ItemID }}
                                {{ if $building.IsGenerator }}
                                <form action="/game/collect" method="post">
                                    {{ else }}
                                    <form action="/game/produce" method="post">
                                        {{ end }}
                                        <input type="hidden" name="building" value="{{ $townBuilding.ID }}">
                                        <input type="hidden" name="product" value="{{ $item.ID }}">
                                        <tr>
                                            <td style="width: 35%;">
                                                <label for="{{ $townBuilding.ID }}_{{ $item.ID }}">
                                                    <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                    {{ $item.Name }}
                                                </label>
                                            </td>
                                            {{ if $building.IsGenerator }}
                                                <td>
                                                    <input id="{{ $townBuilding.ID }}_{{ $item.ID }}" type="number"
                                                           name="quantity" value="46" disabled>
                                                </td>
                                                <td>
                                                    <input type="submit" value="Collect">
                                                </td>
                                            {{ else }}
                                                <td>
                                                    <input id="{{ $townBuilding.ID }}_{{ $item.ID }}" type="number"
                                                           name="quantity">
                                                </td>
                                                <td>
                                                    <input type="submit" value="Produce">
                                                </td>
                                            {{ end }}
                                        </tr>
                                    </form>
                                    {{ end }}
                                </tbody>
                            </table>

                            {{ $queuedJobs := index $.QueuedJobs $townBuilding.ID }}
                            {{ if $queuedJobs }}
                                {{ range $job := $queuedJobs }}
                                    <hr class="divider">
                                    <div class="row reverse">
                                        <div class="col-4 text-right">
                                            <input type="button" class="button small error" value="Cancel">
                                        </div>
                                        <div class="col-8">
                                            <strong>Consuming</strong><br>
                                            {{ range $jobItem := $job.ProductJob.Consumption }}
                                                {{ $item := index $.Items $jobItem.ItemID}}
                                                <p>
                                                    {{ $jobItem.Quantity }}x
                                                    <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                    {{ $item.Name }}
                                                </p>
                                            {{ end}}
                                            <strong>Producing</strong><br>
                                            {{ range $jobItem := $job.ProductJob.Production }}
                                                {{ $item := index $.Items $jobItem.ItemID}}
                                                <p>
                                                    {{ $jobItem.Quantity }}x
                                                    <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                    {{ $item.Name }}
                                                </p>
                                            {{ end}}
                                        </div>
                                        <div class="col-12">
                                                <p><strong>Status</strong><br>{{ $job.Status }}</p>
                                            {{ if $job.IsActive }}
                                                <p><strong>Started at</strong><br>{{ $job.StartedAt }}</p>
                                                <p><strong>Ready at</strong><br>{{ $job.ReadyAt }}</p>
                                            {{ else }}
                                                <p><strong>Queued at</strong><br>{{ $job.QueuedAt }}</p>
                                            {{ end }}
                                            {{ if $job.IsActive }}
                                                <p><strong>Progress</strong><br>
                                                    {{ $job.Progress }}%
                                                    <progress max="100" value="{{ $job.Progress }}"></progress>
                                                </p>
                                            {{ end }}
                                        </div>
                                    </div>
                                {{ end }}
                            {{ end }}
                        </div>
                        <div id="tb_{{ $townBuilding.ID }}_construction" class="tb_pane_{{ $townBuilding.ID }}"
                             role="tabpanel" tabindex="0" hidden>
                            <table class="striped">
                                <tbody>
                                {{ range $level, $cost := $building.BuildCosts }}
                                    <tr>
                                        <th>Lvl {{ $level }}</th>
                                        <td>
                                            <img src="/images/items/stone.png" alt="Stones">
                                            {{ $cost.Stones }}x
                                        </td>
                                        <td>
                                            <img src="/images/items/plank.png" alt="Planks">
                                            {{ $cost.Planks }}x
                                        </td>
                                    </tr>
                                {{ end }}
                                </tbody>
                            </table>
                            <footer class="is-right">
                                <a href="#" class="button small success">Upgrade</a>
                                <a href="#" class="button small error">Demolish</a>
                            </footer>
                        </div>
                    </div>
                </div>
            {{ else }}
                <div class="col">
                    <div class="card">
                        <header>
                            <h3>Buildings</h3>
                        </header>
                        <p>
                            Your town has no buildings yet. Queue some up in the build queue!
                        </p>
                    </div>
                </div>
            {{ end }}
        </div>
        <div class="row" id="warehouse">
            <div class="col">
                <div class="card">
                    <header>
                        <h3>Warehouse</h3>
                    </header>
                    <div class="row">
                        <div class="col">
                            <table class="striped">
                                <thead>
                                <tr>
                                    <th style="width: 4rem;">&nbsp;</th>
                                    <th>Name</th>
                                    <th style="width: 4rem;">Quantity</th>
                                </tr>
                                </thead>
                                <tbody>
                                {{ range $itemID := .WarehouseList }}
                                {{ $item := index $.Items $itemID }}
                                <tr>
                                    <td><img src="{{ $item.Image }}" alt="{{ $item.Name }}"></td>
                                    <td>{{ $item.Name }}</td>
                                    <td>{{ with (index $.Warehouse $item.ID) }} {{ .Quantity }} {{ end }}</td>
                                </tr>
                                {{ if hasItemID $.WarehouseBreakpoints $item.ID }}
                                </tbody>
                            </table>
                        </div>
                        <div class="col">
                            <table class="striped">
                                <thead>
                                <tr>
                                    <th style="width: 4rem;">&nbsp;</th>
                                    <th>Name</th>
                                    <th style="width: 4rem;">Quantity</th>
                                </tr>
                                </thead>
                                <tbody>
                                {{ end }}
                                {{ end }}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="buildqueue">
            <div class="col">
                <div class="card is-full-height" style="background: #d3d3d7;">
                    <nav id="queue_tabs" class="tabs" role="tablist">
                        <a id="queue_tab_queue" aria-controls="queue_pane_queue" class="active">Build queue</a>
                        <a id="queue_tab_building" aria-controls="queue_pane_building">New building</a>
                    </nav>
                    <div id="queue_pane_queue" class="queue_pane" role="tabpanel" tabindex="0"
                         aria-labelledby="queue_tab_queue">
                        <!-- Queue -->
                        <p>
                            At your current level you can have up to <strong>3</strong> buildings in the queue.
                        </p>
                        {{ range $buildingQ := .QueuedBuildings }}
                            {{ $building := index $.Buildings $buildingQ.BuildingJob.Type }}
                            <hr class="divider">
                            <div class="row">
                                <div class="col text-center">
                                    <img src="{{ $building.Image }}" alt="{{ $building.Name }}">
                                </div>
                                <div class="col text-center">
                                    <h4>{{ $building.Name }}</h4>
                                    Level {{ $buildingQ.BuildingJob.Level }}
                                </div>
                                <div class="col text-center">
                                        <p><strong>Status</strong><br>{{ $buildingQ.Status }}</p>
                                    {{ if $buildingQ.IsActive }}
                                        <p><strong>Started at</strong><br>{{ $buildingQ.StartedAt }}</p>
                                        <p><strong>Ready at</strong><br>{{ $buildingQ.ReadyAt }}</p>
                                    {{ else }}
                                        <p><strong>Queued at</strong><br>{{ $buildingQ.QueuedAt }}</p>
                                    {{ end }}
                                    {{ $buildingQ.Progress }}%
                                    <progress max="100" value="{{ $buildingQ.Progress }}"></progress>
                                </div>
                                <div class="col text-center">
                                    <a href="#" class="button error">Cancel</a>
                                </div>
                            </div>
                        {{ else }}
                            <p>
                                No buildings queued.
                            </p>
                        {{ end }}
                    </div>

                    <div id="queue_pane_building" class="queue_pane" role="tabpanel" tabindex="0"
                         aria-labelledby="queue_tab_building" hidden>
                        <!-- Form -->
                        <p>
                            At your current level you can have up to <strong>10</strong> buildings.
                            You currently have <strong>{{ len .Town.Buildings }}</strong>.
                        </p>
                        <form action="/game/queue" method="post">
                            <p>
                                <label for="building">Building:</label>
                                <select name="building" id="building">
                                    {{ range $key, $building := .Buildings }}
                                        <option value="{{ $key }}">
                                            {{ $building.Name }} &mdash;
                                            {{ $cost := index $building.BuildCosts 1 }}
                                            {{ $cost.Stones }}x stones, {{ $cost.Planks }}x planks
                                        </option>
                                    {{ end }}
                                </select>
                            </p>
                            <input type="submit" value="Build">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{{ end }}