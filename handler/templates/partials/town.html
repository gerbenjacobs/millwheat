{{ define "partial-town" }}
    <div class="row" id="town">
        {{ range $townBuilding := .Town.OrderedBuildings }}
            {{ $building := index $.Buildings $townBuilding.Type }}
            <div class="col-6 col-4-md">
                <div class="card is-full-height">
                    <header>
                        <h3>{{ $building.Name }}</h3>
                    </header>
                    <img src="{{ $building.Image }}" alt="{{ $building.Name }}" class="pull-right">
                    <p>{{ $building.Description }}</p>
                    <span class="clearfix">&nbsp;</span>
                    <nav class="tabs is-full" role="tablist">
                        <a aria-controls="tb_{{ $townBuilding.ID }}_overview" class="tb_tab active">
                            <img src="https://icongr.am/feather/home.svg" alt="Overview">
                        </a>
                        <a aria-controls="tb_{{ $townBuilding.ID }}_production" class="tb_tab">
                            <img src="https://icongr.am/feather/package.svg" alt="Production">
                        </a>
                        <a aria-controls="tb_{{ $townBuilding.ID }}_construction" class="tb_tab">
                            <img src="https://icongr.am/feather/settings.svg" alt="Construction">
                        </a>
                    </nav>
                    <div id="tb_{{ $townBuilding.ID }}_overview" class="tb_pane_{{ $townBuilding.ID }}"
                         role="tabpanel" tabindex="0">
                        <table class="striped">
                            <tr>
                                <th style="width: 50%;">Level</th>
                                <td>{{ $townBuilding.CurrentLevel }}</td>
                            </tr>
                            <tr>
                                <th>Consumes</th>
                                <td>
                                    {{ range $consume := $building.ConsumesList }}
                                        {{ $item := index $.Items $consume }}
                                        <p>
                                            <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                            {{ $item.Name }}
                                        </p>
                                    {{ else }}
                                        <em>Nothing</em>
                                    {{ end }}
                                </td>
                            </tr>
                            <tr>
                                <th>Produces</th>
                                <td>
                                    {{ range $produce := $building.ProducesList }}
                                        {{ $item := index $.Items $produce }}
                                        <p>
                                            <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                            {{ $item.Name }}
                                        </p>
                                    {{ else }}
                                        <em>Nothing</em>
                                    {{ end }}
                                </td>
                            </tr>
                            {{ range $mechanic := $building.MechanicsList }}
                                <tr>
                                    <th>{{ $mechanic.Name }}</th>
                                    <td>{{ index $mechanic.Levels $townBuilding.CurrentLevel }}</td>
                                </tr>
                            {{ end }}
                            {{ if $building.IsGenerator }}
                                <tr>
                                    <th>Last collected</th>
                                    <td>{{ $townBuilding.LastCollectionAt }}</td>
                                </tr>
                            {{ end }}
                        </table>
                    </div>
                    <div id="tb_{{ $townBuilding.ID }}_production" class="tb_pane_{{ $townBuilding.ID }}"
                         role="tabpanel" tabindex="0" hidden>
                        <table class="striped">
                            {{ range $mechanic := $building.MechanicsList }}
                                <tr>
                                    <td>
                                        <strong>{{ $mechanic.Name }}</strong><br>
                                        <em>{{ $mechanic.Type }}</em>
                                    </td>
                                    <td>{{ index $mechanic.Levels $townBuilding.CurrentLevel }}</td>
                                </tr>
                            {{ end }}
                        </table>

                        <table class="striped">
                            <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>&nbsp;</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{ range $produce, $set := $building.Production }}
                            {{ $item := index $.Items $produce.ItemID }}
                            {{ if $building.IsGenerator }}
                            <form action="/game/collect" method="post">
                                {{ else }}
                                <form action="/game/produce" method="post">
                                    {{ end }}
                                    <input type="hidden" name="building" value="{{ $townBuilding.ID }}">
                                    <input type="hidden" name="product" value="{{ $item.ID.AsKey }}">
                                    <tr>
                                        <td style="width: 35%;">
                                            <label for="{{ $townBuilding.ID }}_{{ $item.ID.AsKey }}">
                                                <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                {{ $item.Name }}
                                            </label>
                                        </td>
                                        {{ if $building.IsGenerator }}
                                            <td>
                                                <input id="{{ $townBuilding.ID }}_{{ $item.ID.AsKey }}" type="number"
                                                       name="quantity" value="{{ $townBuilding.CurrentProduction }}"
                                                       disabled>
                                            </td>
                                            <td>
                                                <input type="submit" value="Collect">
                                            </td>
                                        {{ else }}
                                            <td>
                                                <input id="{{ $townBuilding.ID }}_{{ $item.ID.AsKey }}" type="number"
                                                       name="quantity" min="1">
                                            </td>
                                            <td>
                                                <input type="submit" value="Produce">
                                            </td>
                                        {{ end }}
                                    </tr>
                                </form>
                                {{ end }}
                            </tbody>
                        </table>

                        {{ $queuedJobs := index $.QueuedJobs $townBuilding.ID }}
                        {{ if $queuedJobs }}
                            {{ range $job := $queuedJobs }}
                                <hr class="divider">
                                <div class="row reverse">
                                    <div class="col-4 text-right">
                                        <form action="/game/cancel" method="post">
                                            <input type="hidden" name="job" value="{{ $job.ID }}">
                                            <input type="submit" class="button small error" value="Cancel">
                                        </form>
                                    </div>
                                    <div class="col-8">
                                        <strong>Consuming</strong><br>
                                        {{ range $jobItem := $job.ProductJob.Consumption }}
                                            {{ $item := index $.Items $jobItem.ItemID}}
                                            <p>
                                                {{ $jobItem.Quantity }}x
                                                <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                {{ $item.Name }}
                                            </p>
                                        {{ end}}
                                        <strong>Producing</strong><br>
                                        {{ range $jobItem := $job.ProductJob.Production }}
                                            {{ $item := index $.Items $jobItem.ItemID}}
                                            <p>
                                                {{ $jobItem.Quantity }}x
                                                <img src="{{ $item.Image }}" alt="{{ $item.Name }}">
                                                {{ $item.Name }}
                                            </p>
                                        {{ end}}
                                    </div>
                                    <div class="col-12">
                                        <p><strong>Status</strong><br>{{ $job.Status }}</p>
                                        {{ if $job.IsActive }}
                                            <p><strong>Started at</strong><br>{{ $job.StartedAt }}</p>
                                            <p><strong>Ready at</strong><br>{{ $job.ReadyAt }}</p>
                                        {{ else }}
                                            <p><strong>Queued at</strong><br>{{ $job.QueuedAt }}</p>
                                        {{ end }}
                                        {{ if $job.IsActive }}
                                            <p><strong>Progress</strong><br>
                                                {{ $job.Progress }}%
                                                <progress max="100" value="{{ $job.Progress }}"></progress>
                                            </p>
                                        {{ end }}
                                    </div>
                                </div>
                            {{ end }}
                        {{ end }}
                    </div>
                    <div id="tb_{{ $townBuilding.ID }}_construction" class="tb_pane_{{ $townBuilding.ID }}"
                         role="tabpanel" tabindex="0" hidden>
                        <table class="striped">
                            <tbody>
                            {{ range $level, $cost := $building.BuildCosts }}
                                <tr>
                                    <th>Lvl {{ $level }}</th>
                                    <td>
                                        <img src="/images/items/stone.png" alt="Stones">
                                        {{ $cost.Stones }}x
                                    </td>
                                    <td>
                                        <img src="/images/items/plank.png" alt="Planks">
                                        {{ $cost.Planks }}x
                                    </td>
                                </tr>
                            {{ end }}
                            </tbody>
                        </table>
                        <footer class="is-right">
                            <form action="/game/upgrade" method="post">
                                <input type="hidden" name="building" value="{{ $townBuilding.ID }}">
                                <input type="submit" value="Upgrade" class="button small success">
                            </form>

                            <form action="/game/demolish" method="post">
                                <input type="hidden" name="building" value="{{ $townBuilding.ID }}">
                                <input type="submit" value="Demolish" class="button small error">
                            </form>
                        </footer>
                    </div>
                </div>
            </div>
        {{ else }}
            <div class="col">
                <div class="card">
                    <header>
                        <h3>Buildings</h3>
                    </header>
                    <p>
                        Your town has no buildings yet. Queue some up in the build queue!
                    </p>
                </div>
            </div>
        {{ end }}
    </div>
{{ end }}